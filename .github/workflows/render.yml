name: Render
on:
  push:
    branches:
      - main
      - Fall22
jobs:
  setup-matrix:
    runs-on: ubuntu-latest
    steps:
      - name: Find Folders
        id: set-matrix
        run: |
          matrix = $((
            echo '{ "lectures" : ['
            find . -name "lecture*" -type d -ls | grep -o "lecture\d*" | sed -r 's/^/"/;s/$/",/'echo "]}"
          ) | jq -c .)
          echo $matrix
          echo $matrix | jq .
          echo "::set-output name=matrix::$matrix"
  check-matrix:
    runs-on: ubuntu-latest
    needs: matrix
    steps:
      - name: Install json2yaml
        run: |
          sudo npm install -g json2yaml
      - name: Check matrix definition
        run: |
          matrix='${{ needs.matrix.outputs.matrix }}'
          echo $matrix
          echo $matrix | jq .
          echo $matrix | json2yaml
  render:
    needs: matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{fromJson(needs.matrix.outputs.matrix)}}
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        persist-credentials: true
    - name: Install Julia
      uses: julia-actions/setup-julia@v1
      with:
        version: 1.6
    - name: Create HTML Slides
      run: |
        julia src/render.jl ${{ matrix.lectures }}
    - name: Build PDF
      run: docker run --rm -t -v `pwd`:/slides -v ~:/home/user astefanutti/decktape ${{ matrix.lectures }}/${{ matrix.lectures }}.html slides/${{ matrix.lectures }}/${{ matrix.lectures }}.pdf
    - name: Commit
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "render notes"
    - name: Copy notes
      uses: andstor/copycat-action@v3
      with:
        personal_token: ${{ secrets.UPDATE_SUBMODULE }}
        repository: 'vsrikrish/environmental-systems-analysis'
        event-type: update-notes
        client-payload: '{"ref": "${{ github.ref }}", "sha": "${{ github.sha }}"}'